# ä»¿å°„ç¼–é˜Ÿé…ç½®æ–¹å¼æ›´æ–° - ä»å…³èŠ‚è§’åº¦å®šä¹‰æ ‡ç§°æ„å‹

## æ›´æ–°æ—¥æœŸ
2025-12-19

## æ›´æ–°æ¦‚è¿°
å°† `AffineFormationActionCfg` çš„æ ‡ç§°æ„å‹é…ç½®æ–¹å¼ä»ç¡¬ç¼–ç çš„æŒ‡å°–ä½ç½®åæ ‡æ”¹ä¸ºé€šè¿‡å…³èŠ‚è§’åº¦å®šä¹‰ï¼Œä½¿é…ç½®æ›´ç›´è§‚å’Œæ˜“äºè°ƒæ•´ã€‚

---

## æ ¸å¿ƒæ”¹è¿›

### ä¹‹å‰çš„æ–¹å¼ï¼ˆå·²å¼ƒç”¨ï¼‰
```python
nominal_fingertip_config=(
    (0.05, -0.03, 0.10),  # index - ç¡¬ç¼–ç åæ ‡ï¼Œä¸ç›´è§‚
    (0.05,  0.00, 0.12),  # middle
    (0.05,  0.03, 0.10),  # ring
    (-0.03, 0.00, 0.08),  # thumb
),
```

**ç¼ºç‚¹**ï¼š
- åæ ‡å€¼éš¾ä»¥ç›´è§‚ç†è§£
- éš¾ä»¥æ‰‹åŠ¨è°ƒæ•´å’Œå®éªŒ
- éœ€è¦æµ‹é‡æˆ–è®¡ç®—æ‰èƒ½è·å¾—åˆç†å€¼

### ç°åœ¨çš„æ–¹å¼ï¼ˆæ¨èï¼‰
```python
nominal_joint_angles={
    "a_1": 0.000, "a_0": -0.750, "a_2": 1.750, "a_3": 0.000,  # index
    "a_5": 0.000, "a_4": 0.000, "a_6": 1.750, "a_7": 0.000,  # middle
    "a_9": 0.000, "a_8": 0.750, "a_10": 1.750, "a_11": 0.000,  # ring
    "a_12": 0.500, "a_13": 1.300, "a_14": 1.500, "a_15": 1.000,  # thumb
},
```

**ä¼˜ç‚¹**ï¼š
- âœ… å…³èŠ‚è§’åº¦æ›´ç›´è§‚æ˜“æ‡‚
- âœ… å¯ç›´æ¥å‚è€ƒLeapHandçš„åˆå§‹å§¿æ€é…ç½®
- âœ… æ˜“äºè°ƒæ•´å’Œå®éªŒä¸åŒæ‰‹å‹
- âœ… è‡ªåŠ¨é€šè¿‡æ­£è¿åŠ¨å­¦(FK)è½¬æ¢ä¸ºæŒ‡å°–ä½ç½®

---

## æŠ€æœ¯å®ç°

### 1. é…ç½®ç±»æ›´æ–° (`affine_formation_cfg.py`)

#### æ–°å¢å‚æ•°
```python
nominal_joint_angles: dict[str, float] | None = None
```

**è¯´æ˜**ï¼š
- å­—å…¸é”®ä¸ºå…³èŠ‚åç§°ï¼ˆå¦‚ "a_1", "a_0" ç­‰ï¼‰
- å­—å…¸å€¼ä¸ºå¯¹åº”çš„å…³èŠ‚è§’åº¦ï¼ˆå•ä½ï¼šradï¼‰
- å¿…é¡»åŒ…å«æ‰€æœ‰16ä¸ªå…³èŠ‚çš„è§’åº¦

#### é…ç½®ä¼˜å…ˆçº§
1. å¦‚æœæä¾› `nominal_joint_angles` â†’ ä½¿ç”¨FKè®¡ç®—æŒ‡å°–ä½ç½®
2. å¦åˆ™ä½¿ç”¨ `nominal_fingertip_config` â†’ ç›´æ¥ä½¿ç”¨åæ ‡ï¼ˆå‘åå…¼å®¹ï¼‰

### 2. å®ç°ç±»æ›´æ–° (`affine_formation.py`)

#### æ–°å¢æ–¹æ³•
```python
def _compute_nominal_fingertip_from_joints(
    self, joint_angles: dict[str, float]
) -> torch.Tensor:
```

**åŠŸèƒ½**ï¼šé€šè¿‡æ­£è¿åŠ¨å­¦ä»å…³èŠ‚è§’åº¦è®¡ç®—æŒ‡å°–ä½ç½®

**æµç¨‹**ï¼š
1. ä¿å­˜å½“å‰å…³èŠ‚çŠ¶æ€
2. è®¾ç½®æœºå™¨äººåˆ°æ ‡ç§°å…³èŠ‚å§¿æ€
3. æ›´æ–°articulationçŠ¶æ€ï¼ˆè§¦å‘FKè®¡ç®—ï¼‰
4. è¯»å–æŒ‡å°–ä½ç½®ï¼ˆä¸–ç•Œåæ ‡ç³»ï¼‰
5. è½¬æ¢åˆ°æ‰‹éƒ¨å±€éƒ¨åæ ‡ç³»
6. æ¢å¤åŸå§‹å…³èŠ‚çŠ¶æ€

**å…³é”®ä»£ç **ï¼š
```python
# è®¾ç½®å…³èŠ‚ä½ç½®
self._asset.write_joint_state_to_sim(target_joint_pos, velocities)

# æ›´æ–°çŠ¶æ€ï¼ˆdt=0è¡¨ç¤ºä»…æ›´æ–°çŠ¶æ€ä¸æ¨è¿›æ—¶é—´ï¼‰
self._asset.update(dt=0.0)

# è¯»å–æŒ‡å°–ä½ç½®
fingertip_pos_w = self._asset.data.body_pos_w[:, self._fingertip_body_ids]

# è½¬æ¢åˆ°å±€éƒ¨åæ ‡ç³»
P_star = fingertip_pos_w - hand_base_pos.unsqueeze(1)
```

---

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨ï¼ˆæ¨èï¼‰

```python
from leaphand.tasks.manager_based.leaphand.mdp import actions as leap_mdp

action_cfg = leap_mdp.AffineFormationActionCfg(
    asset_name="robot",
    nominal_joint_angles={
        # Index finger
        "a_1": 0.000,
        "a_0": -0.750,
        "a_2": 1.750,
        "a_3": 0.000,
        # Middle finger
        "a_5": 0.000,
        "a_4": 0.000,
        "a_6": 1.750,
        "a_7": 0.000,
        # Ring finger
        "a_9": 0.000,
        "a_8": 0.750,
        "a_10": 1.750,
        "a_11": 0.000,
        # Thumb
        "a_12": 0.500,
        "a_13": 1.300,
        "a_14": 1.500,
        "a_15": 1.000,
    },
    # ... å…¶ä»–é…ç½®
)
```

### å‘åå…¼å®¹ï¼ˆä¸æ¨èï¼‰

ä»ç„¶å¯ä»¥ä½¿ç”¨æ—§çš„åæ ‡æ–¹å¼ï¼Œä½†ä¸æ¨èï¼š

```python
action_cfg = leap_mdp.AffineFormationActionCfg(
    asset_name="robot",
    nominal_fingertip_config=(
        (0.05, -0.03, 0.10),
        (0.05,  0.00, 0.12),
        (0.05,  0.03, 0.10),
        (-0.03, 0.00, 0.08),
    ),
    # ... å…¶ä»–é…ç½®
)
```

---

## é…ç½®éªŒè¯

### å®Œæ•´æ€§æ£€æŸ¥
å¦‚æœä½¿ç”¨ `nominal_joint_angles`ï¼Œé…ç½®ç±»ä¼šè‡ªåŠ¨éªŒè¯ï¼š

âœ… **é€šè¿‡éªŒè¯**ï¼š
```python
nominal_joint_angles = {
    "a_1": 0.0, "a_0": -0.75, ...,  # åŒ…å«æ‰€æœ‰16ä¸ªå…³èŠ‚
}
```

âŒ **æŠ›å‡ºé”™è¯¯**ï¼š
```python
# ç¼ºå°‘éƒ¨åˆ†å…³èŠ‚
nominal_joint_angles = {
    "a_1": 0.0, "a_0": -0.75,  # åªæœ‰2ä¸ªå…³èŠ‚
}
# ValueError: ç¼ºå¤±å…³èŠ‚: ['a_2', 'a_3', ...]
```

âŒ **æŠ›å‡ºé”™è¯¯**ï¼š
```python
# åŒ…å«ä¸å­˜åœ¨çš„å…³èŠ‚
nominal_joint_angles = {
    "a_1": 0.0, ..., "a_16": 1.0,  # a_16ä¸å­˜åœ¨
}
# ValueError: å¤šä½™å…³èŠ‚: ['a_16']
```

### è‡³å°‘æä¾›ä¸€ç§é…ç½®
```python
# âŒ ä¸¤è€…éƒ½ä¸æä¾›ä¼šæŠ¥é”™
AffineFormationActionCfg(
    asset_name="robot",
    nominal_joint_angles=None,
    nominal_fingertip_config=None,
)
# ValueError: å¿…é¡»æä¾› nominal_joint_angles æˆ– nominal_fingertip_config å…¶ä¸­ä¹‹ä¸€
```

---

## å…³èŠ‚åç§°ä¸é¡ºåº

### LeapHandå…³èŠ‚æ˜ å°„
```python
finger_joints = {
    "index": ["a_1", "a_0", "a_2", "a_3"],      # é£ŸæŒ‡: 4ä¸ªå…³èŠ‚
    "middle": ["a_5", "a_4", "a_6", "a_7"],     # ä¸­æŒ‡: 4ä¸ªå…³èŠ‚
    "ring": ["a_9", "a_8", "a_10", "a_11"],     # æ— åæŒ‡: 4ä¸ªå…³èŠ‚
    "thumb": ["a_12", "a_13", "a_14", "a_15"],  # æ‹‡æŒ‡: 4ä¸ªå…³èŠ‚
}
```

### æŒ‡å°–åˆšä½“é¡ºåº
```python
finger_bodies = (
    "fingertip",        # é£ŸæŒ‡æœ«ç«¯
    "fingertip_2",      # ä¸­æŒ‡æœ«ç«¯
    "fingertip_3",      # æ— åæŒ‡æœ«ç«¯
    "thumb_fingertip",  # æ‹‡æŒ‡æœ«ç«¯
)
```

**æ³¨æ„**ï¼šFKè®¡ç®—åçš„æŒ‡å°–ä½ç½®ä¼šè‡ªåŠ¨æŒ‰æ­¤é¡ºåºæ’åˆ—ã€‚

---

## æ€§èƒ½è€ƒè™‘

### FKè®¡ç®—å¼€é”€
- **æ—¶æœº**ï¼šä»…åœ¨åŠ¨ä½œé¡¹åˆå§‹åŒ–æ—¶æ‰§è¡Œä¸€æ¬¡
- **æ“ä½œ**ï¼š
  1. å†™å…¥å…³èŠ‚çŠ¶æ€
  2. æ›´æ–°articulationï¼ˆè§¦å‘FKï¼‰
  3. è¯»å–æŒ‡å°–ä½ç½®
  4. æ¢å¤åŸå§‹çŠ¶æ€
- **è€—æ—¶**ï¼š< 1msï¼ˆå¯å¿½ç•¥ï¼‰

### è¿è¡Œæ—¶æ€§èƒ½
- âœ… æ— é¢å¤–å¼€é”€ï¼šæ ‡ç§°æ„å‹ `P_star` åœ¨åˆå§‹åŒ–åç¼“å­˜
- âœ… è®­ç»ƒæ—¶ä½¿ç”¨ç¼“å­˜çš„tensorï¼Œæ— FKé‡å¤è®¡ç®—

---

## è°ƒè¯•æŠ€å·§

### éªŒè¯æ ‡ç§°æ„å‹æ˜¯å¦åˆç†

åœ¨ `random_agent.py` æˆ–è®­ç»ƒè„šæœ¬ä¸­æ·»åŠ ï¼š

```python
# åˆå§‹åŒ–ç¯å¢ƒå
action_term = env.action_manager.get_term("affine_formation")
P_star = action_term._P_star[0].cpu().numpy()  # ç¬¬ä¸€ä¸ªç¯å¢ƒçš„æ ‡ç§°æ„å‹

print("æ ‡ç§°æŒ‡å°–ä½ç½® P* (ç›¸å¯¹äºæ‰‹éƒ¨åŸºåº§):")
print(f"  Index:  {P_star[0]}")
print(f"  Middle: {P_star[1]}")
print(f"  Ring:   {P_star[2]}")
print(f"  Thumb:  {P_star[3]}")
```

**æœŸæœ›è¾“å‡º**ï¼ˆè¿‘ä¼¼å€¼ï¼‰ï¼š
```
æ ‡ç§°æŒ‡å°–ä½ç½® P* (ç›¸å¯¹äºæ‰‹éƒ¨åŸºåº§):
  Index:  [ 0.04  -0.03   0.09]
  Middle: [ 0.05   0.00   0.11]
  Ring:   [ 0.05   0.03   0.09]
  Thumb:  [-0.03   0.00   0.07]
```

### å¯è§†åŒ–æ ‡ç§°æ‰‹å‹

å»ºè®®åœ¨Isaac Sim UIä¸­ï¼š
1. æš‚åœä»¿çœŸ
2. æ‰‹åŠ¨è®¾ç½®æœºå™¨äººå…³èŠ‚åˆ°æ ‡ç§°è§’åº¦
3. è§‚å¯Ÿæ‰‹å‹æ˜¯å¦åˆç†
4. å¾®è°ƒ `nominal_joint_angles` ä¸­çš„å€¼

---

## è¿ç§»æŒ‡å—

### ä»æ—§é…ç½®è¿ç§»

**Step 1**: æ‰¾åˆ°ä½ çš„æ—§é…ç½®
```python
# æ—§çš„é…ç½®ï¼ˆinhand_affine_env_cfg.pyï¼‰
nominal_fingertip_config=(
    (0.05, -0.03, 0.10),
    (0.05,  0.00, 0.12),
    (0.05,  0.03, 0.10),
    (-0.03, 0.00, 0.08),
),
```

**Step 2**: æ›¿æ¢ä¸ºå…³èŠ‚è§’åº¦
```python
# æ–°çš„é…ç½®
nominal_joint_angles={
    "a_1": 0.000, "a_0": -0.750, "a_2": 1.750, "a_3": 0.000,
    "a_5": 0.000, "a_4": 0.000, "a_6": 1.750, "a_7": 0.000,
    "a_9": 0.000, "a_8": 0.750, "a_10": 1.750, "a_11": 0.000,
    "a_12": 0.500, "a_13": 1.300, "a_14": 1.500, "a_15": 1.000,
},
```

**Step 3**: ç§»é™¤æ—§çš„ `nominal_fingertip_config` è¡Œ

**Step 4**: æµ‹è¯•
```bash
python random_agent.py --task Template-Leaphand-Affine-Manager-v0
```

---

## å¸¸è§é—®é¢˜

### Q1: å…³èŠ‚è§’åº¦çš„å•ä½æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: å¼§åº¦ï¼ˆradï¼‰ã€‚ä¾‹å¦‚ï¼š
- `0.0` rad = 0Â°
- `1.57` rad â‰ˆ 90Â°
- `3.14` rad â‰ˆ 180Â°

### Q2: å¦‚ä½•è·å¾—åˆé€‚çš„å…³èŠ‚è§’åº¦å€¼ï¼Ÿ
**A**: ä¸‰ç§æ–¹æ³•ï¼š
1. å‚è€ƒ `inhand_base_env_cfg.py` ä¸­çš„åˆå§‹å…³èŠ‚é…ç½®ï¼ˆæ¨èï¼‰
2. åœ¨Isaac Sim UIä¸­æ‰‹åŠ¨è°ƒæ•´å…³èŠ‚å¹¶è®°å½•è§’åº¦
3. ä»æˆåŠŸçš„è®­ç»ƒè½¨è¿¹ä¸­æå–

### Q3: FKè®¡ç®—ä¼šå½±å“ä»¿çœŸå—ï¼Ÿ
**A**: ä¸ä¼šã€‚FKè®¡ç®—åªåœ¨åˆå§‹åŒ–æ—¶æ‰§è¡Œï¼Œä¸”ä¼šæ¢å¤åŸå§‹çŠ¶æ€ã€‚è¿è¡Œæ—¶ä¸å½±å“ä»¿çœŸã€‚

### Q4: å¯ä»¥æ··ç”¨ä¸¤ç§é…ç½®æ–¹å¼å—ï¼Ÿ
**A**: ä¸å¯ä»¥ã€‚é…ç½®ç±»ä¼šä¼˜å…ˆä½¿ç”¨ `nominal_joint_angles`ã€‚å¦‚æœæä¾›äº†å…³èŠ‚è§’åº¦ï¼ŒæŒ‡å°–ä½ç½®é…ç½®ä¼šè¢«å¿½ç•¥ã€‚

### Q5: å¦‚ä½•éªŒè¯FKè®¡ç®—æ˜¯å¦æ­£ç¡®ï¼Ÿ
**A**: åœ¨åˆå§‹åŒ–åæ‰“å° `action_term._P_star`ï¼Œæ£€æŸ¥åæ ‡æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…ï¼ˆé€šå¸¸åœ¨Â±0.1må†…ï¼‰ã€‚

---

## ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

```
AnyRotate/source/leaphand/leaphand/tasks/manager_based/leaphand/
â”œâ”€â”€ mdp/actions/
â”‚   â”œâ”€â”€ affine_formation_cfg.py  [MODIFIED] æ·»åŠ nominal_joint_angleså‚æ•°å’ŒéªŒè¯
â”‚   â””â”€â”€ affine_formation.py      [MODIFIED] æ·»åŠ FKè®¡ç®—æ–¹æ³•
â””â”€â”€ inhand_affine_env_cfg.py     [MODIFIED] ä½¿ç”¨æ–°çš„é…ç½®æ–¹å¼
```

---

## ä¸‹ä¸€æ­¥

1. âœ… é…ç½®å·²æ›´æ–°ä¸ºä½¿ç”¨å…³èŠ‚è§’åº¦
2. ğŸš€ å¯ä»¥ç›´æ¥å¼€å§‹è®­ç»ƒï¼š
   ```bash
   python IsaacLab/source/standalone/workflows/rl_games/train.py \
       --task Template-Leaphand-Affine-Manager-v0 \
       --num_envs 4096 \
       --headless
   ```
3. ğŸ“Š è®­ç»ƒè¿‡ç¨‹ä¸­ç›‘æ§TensorBoard
4. ğŸ” å¯¹æ¯”Baselineå’ŒAffineçš„æ€§èƒ½

Good luck with your training! ğŸ¯
